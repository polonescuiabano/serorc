<app-topbar-detalhesorcamento
  [orcamento]="orcamento"
  (encargosAlterados)="recalcularEncargos($event)">
</app-topbar-detalhesorcamento>
<app-sidebar></app-sidebar>

<!-- Cabe√ßalho do or√ßamento -->
<div class="cabecalho-orcamento">
  <h2>Detalhes: {{ orcamento?.nome }}</h2>
  <button (click)="iniciarAdicionarEtapa()">+ Etapa</button>
</div>

<table *ngIf="orcamento && orcamento.itens?.length" class="tabela-itens">
  <thead>
  <tr>
    <th>N√≠vel</th><th>C√≥digo</th><th>Tipo</th><th>Descri√ß√£o</th>
    <th>Unidade</th><th>Qtd</th><th>Valor U.</th>
    <th>Valor c/ BDI</th><th>Total</th><th>A√ß√µes</th>
  </tr>
  </thead>
  <tbody>
  <ng-container *ngFor="let i of itensOrdenados">
    <!-- Linha principal do item -->
    <tr (click)="onSelectItem(i)">
      <td>{{ i.nivel }}</td>
      <td>{{ i.codigo }}</td>
      <td>{{ i.tipo }}</td>
      <td>{{ i.descricao }}</td>
      <td>{{ i.unidade }}</td>
      <td>{{ i.quantidade }}</td>
      <td>{{ i.precoUnitario | currency }}</td>
      <td>{{ i.valorComBdi | currency }}</td>
      <td>{{ i.total | currency }}</td>
      <td>
        <button (click)="excluir(i.id); $event.stopPropagation()">üóëÔ∏è</button>
        <button *ngIf="i.tipo === 'etapa' || i.tipo === 'subetapa'"
                (click)="iniciarNovaEtapa(); $event.stopPropagation()">‚úèÔ∏è</button>
      </td>
    </tr>

    <!-- Linha com bot√µes de a√ß√£o (logo ap√≥s o item selecionado) -->
    <tr *ngIf="selectedItem?.nivel === i.nivel" class="acoes-item-selecionado">
      <td colspan="10">
        <button (click)="iniciarAdicionarEtapa()">+ Etapa</button>
        <button (click)="iniciarNovaSubetapa(selectedItem!)">+ Subetapa</button>
        <button (click)="iniciarAdicionar('composicao', selectedItem)">+ Composi√ß√£o</button>
        <button (click)="iniciarAdicionar('insumo', selectedItem)">+ Insumo</button>
      </td>
    </tr>

    <!-- Linha de edi√ß√£o (inserida abaixo do √∫ltimo filho direto ou abaixo do pai se n√£o h√° filhos) -->
    <tr *ngIf="editandoItem && selectedItem && isUltimoFilhoDireto(i)" class="linha-edicao">
      <td><input type="text" [(ngModel)]="editandoItem.item.nivel" placeholder="N√≠vel" /></td>

      <td>
        <input [(ngModel)]="editandoItem.buscaCodigo" placeholder="C√≥digo"
               (ngModelChange)="onBuscarRealTime()" />
      </td>

      <td>{{ editandoItem.tipo }}</td>

      <td>
        <input [(ngModel)]="editandoItem.buscaDescricao" placeholder="Descri√ß√£o"
               (ngModelChange)="onBuscarRealTime()" />
        <div *ngIf="editandoItem.resultados?.length" class="resultados-busca">
          <ul>
            <li *ngFor="let r of editandoItem.resultados"
                (click)="selecionar(r)">
              {{ r.codigo }} - {{ editandoItem.tipo === 'composicao' ? r.descricao : r.nome }}
            </li>
          </ul>
        </div>
      </td>

      <td>
        <select [(ngModel)]="editandoItem.item.base">
          <option *ngFor="let b of orcamento?.bancos" [value]="b.nome + ' ' + b.periodo">
            {{ b.nome }} {{ b.periodo }}
          </option>
        </select>
      </td>

      <td><input type="number" [(ngModel)]="editandoItem.item.quantidade" placeholder="Qtd" /></td>

      <td>{{ editandoItem.item.precoUnitario | currency }}</td>
      <td>{{ (editandoItem.item?.precoUnitario ?? 0) * (1 + (orcamento?.bdi ?? 0)/100) | currency }}</td>
      <td>{{ ((editandoItem.item?.precoUnitario ?? 0) * (1 + (orcamento?.bdi ?? 0)/100)) * (editandoItem.item?.quantidade ?? 0) | currency }}</td>

      <td>
        <button (click)="confirmarEdicao()">‚úî</button>
        <button (click)="cancelarEdicao()">‚úñ</button>
      </td>
    </tr>
  </ng-container>
  </tbody>
</table>

<!-- Nova etapa (inserida fora da lista principal) -->
<table *ngIf="novaEtapa" class="tabela-nova-etapa">
  <tr>
    <td><input type="text" [(ngModel)]="novaEtapa.nivel" placeholder="N√≠vel" /></td>
    <td>Etapa</td>
    <td><input type="text" [(ngModel)]="novaEtapa.descricao" placeholder="Descri√ß√£o" /></td>
    <td><input type="number" [(ngModel)]="novaEtapa.quantidade" placeholder="Qtd" /></td>
    <td>
      <button (click)="confirmarNovaEtapa()">‚úî</button>
      <button (click)="cancelarNovaEtapa()">‚úñ</button>
    </td>
  </tr>
</table>

<div class="resumo-totais">
  <p><strong>Total sem BDI:</strong> {{ orcamento?.totalSemBDI | currency:'BRL' }}</p>
  <p><strong>Total com BDI:</strong> {{ orcamento?.totalComBDI | currency:'BRL' }}</p>
  <p><strong>Total final:</strong> {{ orcamento?.totalFinal | currency:'BRL' }}</p>
</div>
